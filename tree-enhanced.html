<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="main.css">
  </head>
<body>
<table border="2">
  <tr>
    <td><canvas id="myCanvas" width="1000" height="700" style="border:1px solid">
      Your browser does not support the HTML5 canvas tag.</canvas></td>
    <td valign="top">
      <div id="dynamicSliders"></div>
    </td>
  </tr>  
</table>

<script src="interface.js"></script>

<script>
//--- PARAMETERS ---  
const c = document.getElementById("myCanvas");
const ctx = c.getContext("2d"); 
const cW=c.clientWidth;
const cH=c.clientHeight;
const pi=Math.PI;

//--- here are defined to be global, the actual values are taken from the external files
var initAngle=pi/2;      //trunk angle
var dAngle=pi/8;         //half of bifurcation angle, pi/8 nice
var initLen=150;         //max 150
var minLen=30;           //20, 25 nice
var reduction=0.8;       //0.8 nice
var initTrunk=20;        //trunk initial thickness
var trunkReduction=0.5;  //trunk => tree reduction factor 
var minBranch=0.1;       // branches min thickness


//-------------------- INIT---------------------------
function init(){
    //ctx.beginPath();     

    initAngle=params["initAngle"].val;          
    dAngle=params["dAngle"].val;            
    initLen=params["initLen"].val;           
    reduction=params["reduction"].val;       
    initTrunk=params["initTrunk"].val;       
    trunkReduction=params["trunkReduction"].val;    
    minBranch=params["minBranch"].val;   

    ctx.shadowBlur = 5;
    ctx.shadowColor = "green";

    draw(0,0,initAngle,initLen,initTrunk);
    //draw(-200,0,initAngle,70,10);
    //draw(200,0,initAngle,80,10);
  }  
//----------------------------------------------------
//--- this functions remap the canvas. The origin is the middle point of the rect base. 
function px(x){
  return cW/2+x;
}
function py(y){
  return cH-y;
}
function plot(x,y) {
  //for debugging only
  ctx.beginPath();
  ctx.fillStyle = "#FF0000";
  ctx.fillRect(x,y,3,3);
}
function rnd(iMin,iMax){
  return iMin+Math.random()*(iMax-iMin);
}


//---------- DRAW --------------------------------------------
function draw(x,y,angle,len,trunk){
  
    var newx=x+len*Math.cos(angle);
    var newy=y+len*Math.sin(angle);
    
    ctx.lineWidth = minBranch+trunk;
    ctx.strokeStyle = "brown";   
    ctx.beginPath();
    //ctx.save(); // check later to better understand

    ctx.moveTo(px(x),py(y));
    ctx.lineTo(px(newx),py(newy));
    ctx.stroke();
    if (len >= minLen) {      

      draw(newx,newy,angle+pi/2*Math.random()*dAngle,len*reduction,trunk*trunkReduction);
      draw(newx,newy,angle-pi/2*Math.random()*dAngle,len*reduction,trunk*trunkReduction);
      draw(newx,newy,angle+pi/24*rnd(-1,1),len*reduction,trunk*trunkReduction);

    } else {
      leaf(newx,newy,.5*len,angle,2*pi/3);
    }
     
  }   
//------------ LEAF ----------------------------------------
function leaf(x,y,l,alpha,beta){
  /*
  x,y coordinate beginning leaf
  l: length of leaf
  alpha: angle of the leaf simmetry line
  b: angle of the arc describing the leaf 
  */
  
  //try changing alpha a little bit to make leaves more natural
  if (alpha<pi/2) {
    alpha=alpha-Math.random();
  } else {
    alpha=alpha+Math.random();
  }


  var r=l/(2*Math.sin(beta/2));
  var gamma=pi/2-beta/2-alpha;
  var xc=0;
  var yc=0;
  


 // leaf first half ----------------------------
    
  //calc center
  xc=x+r*Math.cos(gamma);
  yc=y-r*Math.sin(gamma);
  
  //leaf'simmetry line
  ctx.beginPath();
  ctx.strokeStyle = "darkgreen";

  ctx.moveTo(px(x),py(y));
  ctx.lineTo(px(x+l*Math.cos(alpha)),py(y+l*Math.sin(alpha)));
  ctx.stroke(); 
  
  //--- leaf 1st arc
  ctx.arc(px(xc),py(yc), r, 2*pi-(pi-gamma-beta),2*pi-(pi-gamma),true);
  ctx.fillStyle = "yellow";
  ctx.fill();
  ctx.stroke();
  
  // leaf second  half ----------------------------
  
  //calc center
  var diagonal=Math.sqrt(r*r-l*l/4)
  xc=xc-2*diagonal*Math.cos(gamma+beta/2);
  yc=2*diagonal*Math.sin(gamma+beta/2)+yc;

  ctx.beginPath();
  ctx.arc(px(xc),py(yc), r, -1*(alpha+beta/2)+pi/2,-1*(alpha-beta/2)+pi/2,false);
  ctx.fillStyle = "lightgreen";
  ctx.fill();
  ctx.stroke();  
}
//-----------------------------------------------------------------------

function initControls() {

  var defaultValue=0;
  var strHTML='<table border="1">';    
    
  //---generate html  
  for (var key in params) {
      
    defaultValue=paramToSlider(key,params[key].default); 
    
    strHTML=strHTML + '<tr>';
    strHTML=strHTML + '<td>'+params[key].label + ':</td>';
    strHTML=strHTML + '<td>'+params[key].minLabel + '</td>';
    strHTML=strHTML + '<td><input type="range" min="0" max="100" value="'+defaultValue+'" id="'+key+'" onchange="updateParam(this.id)"></td>';
    strHTML=strHTML + '<td>'+params[key].maxLabel + '</td>';
    strHTML=strHTML + '</td></tr>';
  }
  strHTML=strHTML + '<tr><td colspan=4><button onclick="reDraw()">Draw!</button></td></tr>';
  strHTML=strHTML + '</table>';
  document.getElementById("dynamicSliders").innerHTML=strHTML;
  
  //--- assign default value to sliders
  for (var key in params) {
      
      defaultValue=paramToSlider(key,params[key].default); 
      document.getElementById(key).value=defaultValue;
  
  }

}

function reDraw() {
  
  ctx.clearRect(0, 0, cW, cH);
  init();
  
}

function updateParam(x) {
  
  var iTemp=1*document.getElementById(x).value;
  params[x].val=sliderToParam(x,iTemp);
  //console.log(params[x].val);
  reDraw();
  
}




init();
initControls();



</script> 
</body>
</html>
